name: Branch Protection Bypass Alert

on:
  push:
    branches: [main, develop, enterprise]

jobs:
  check-bypass:
    runs-on: ubuntu-latest
    steps:
      - name: Check if push was via PR merge
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking commit ${{ github.sha }}..."

          # Retry logic to handle GitHub API propagation delay
          # The push event can trigger before the PR merge is fully indexed
          MAX_RETRIES=3
          RETRY_DELAY=2

          for i in $(seq 1 $MAX_RETRIES); do
            MERGED_AT=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
              --jq '.[0].merged_at // "null"' 2>/dev/null) || MERGED_AT="error"

            if [ "$MERGED_AT" != "null" ] && [ "$MERGED_AT" != "error" ] && [ -n "$MERGED_AT" ]; then
              PR_NUM=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
                --jq '.[0].number' 2>/dev/null)
              echo "✓ Commit came from merged PR #$PR_NUM (merged at $MERGED_AT)"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "Attempt $i: No merged PR found yet, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          # All retries exhausted
          if [ "$MERGED_AT" = "error" ]; then
            echo "⚠ API error after $MAX_RETRIES attempts"
          else
            echo "⚠ No merged PR found after $MAX_RETRIES attempts - possible direct push or bypass"
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Send Slack alert
        if: steps.check.outputs.skip == 'false'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_USER_ID: ${{ secrets.SLACK_ADMIN_USER_ID }}
        run: |
          # Escape special characters for JSON
          COMMIT_MSG=$(cat << 'MSGEOF'
          ${{ github.event.head_commit.message }}
          MSGEOF
          )
          ESCAPED_MSG=$(echo "$COMMIT_MSG" | head -1 | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g' | tr -d '\n\r')

          curl -s -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"$SLACK_USER_ID\",
              \"text\": \":warning: *Branch Protection Bypass Detected*\\n\\n*Repo:* ${{ github.repository }}\\n*Branch:* ${{ github.ref_name }}\\n*Pusher:* ${{ github.actor }}\\n*Commit:* \`${{ github.sha }}\`\\n*Message:* ${ESCAPED_MSG}\\n\\n<${{ github.event.head_commit.url }}|View Commit>\"
            }"
